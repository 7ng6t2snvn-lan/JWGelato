<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0f172a">
  <title>Gelato Formulator</title>
  <link rel="manifest" href="./manifest.json">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    :root{--bg:#0f172a;--card:#1e293b;--input:#334155;--accent:#f59e0b;--success:#10b981;--warn:#f59e0b;--danger:#ef4444;--text:#f8fafc;--text2:#94a3b8;--muted:#64748b;--border:#334155;--r:12px}
    body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
    .pin-screen{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;background:linear-gradient(180deg,#0f172a,#1e293b)}
    .pin-logo{font-size:56px;margin-bottom:16px}.pin-title{font-size:28px;font-weight:700;margin-bottom:8px}.pin-sub{font-size:14px;color:var(--text2);margin-bottom:40px}
    .pin-dots{display:flex;gap:16px;margin-bottom:40px}.pin-dot{width:14px;height:14px;border-radius:50%;border:2px solid var(--accent);transition:all .15s}.pin-dot.filled{background:var(--accent)}.pin-dot.error{border-color:var(--danger);background:var(--danger);animation:shake .3s}
    @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-6px)}75%{transform:translateX(6px)}}
    .pin-pad{display:grid;grid-template-columns:repeat(3,72px);gap:14px}.pin-key{width:72px;height:72px;border-radius:50%;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:26px;font-weight:600;cursor:pointer}.pin-key:active{background:var(--accent);transform:scale(.95)}.pin-key.empty{visibility:hidden}
    .app{min-height:100vh;display:flex;flex-direction:column}
    .header{background:var(--card);border-bottom:1px solid var(--border);padding:16px 20px;position:sticky;top:0;z-index:100}
    .header-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}.header-brand{display:flex;align-items:center;gap:10px}.header-icon{font-size:26px}.header-title{font-size:20px;font-weight:700}
    .header-btns{display:flex;gap:8px}.icon-btn{width:38px;height:38px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text2);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center}.icon-btn:hover{background:var(--input);color:var(--text)}
    .tabs{display:flex;gap:4px;background:var(--bg);padding:4px;border-radius:var(--r)}.tab{flex:1;padding:10px 12px;border-radius:8px;border:none;background:transparent;color:var(--text2);font-size:13px;font-weight:600;cursor:pointer}.tab.active{background:var(--accent);color:var(--bg)}
    .content{flex:1;padding:20px;padding-bottom:40px}
    .page-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}.page-title{font-size:20px;font-weight:700}.page-sub{font-size:13px;color:var(--muted)}
    .add-btn{display:flex;align-items:center;gap:6px;padding:10px 16px;border-radius:8px;border:none;background:var(--accent);color:var(--bg);font-size:14px;font-weight:600;cursor:pointer}
    .filters{display:flex;gap:8px;margin-bottom:16px;overflow-x:auto}.filter{padding:8px 14px;border-radius:20px;border:1px solid var(--border);background:transparent;color:var(--text2);font-size:13px;font-weight:500;cursor:pointer;white-space:nowrap}.filter.active{background:rgba(245,158,11,.15);border-color:var(--accent);color:var(--accent)}
    .recipe-grid{display:flex;flex-direction:column;gap:12px}
    .recipe-card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:16px;cursor:pointer}.recipe-card:hover{border-color:var(--accent)}
    .recipe-top{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:14px}.recipe-info{display:flex;align-items:center;gap:12px}.recipe-emoji{font-size:36px}.recipe-name{font-size:16px;font-weight:600;margin-bottom:2px}.recipe-meta{font-size:12px;color:var(--muted)}
    .badge{padding:4px 10px;border-radius:10px;font-size:10px;font-weight:700;text-transform:uppercase}.badge-gelato{background:rgba(245,158,11,.15);color:var(--accent)}.badge-sorbet{background:rgba(168,85,247,.15);color:#c084fc}
    .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}.stat-box{text-align:center;padding:10px 6px;background:var(--bg);border-radius:8px}.stat-val{font-family:'JetBrains Mono',monospace;font-size:15px;font-weight:600}.stat-val.good{color:var(--success)}.stat-val.warn{color:var(--warn)}.stat-val.bad{color:var(--danger)}.stat-lbl{font-size:10px;color:var(--muted);text-transform:uppercase;margin-top:2px}
    .detail-header{display:flex;align-items:center;gap:12px;margin-bottom:20px}.back-btn{width:40px;height:40px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text);font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center}.detail-title{flex:1}.detail-name{font-size:22px;font-weight:700}.detail-sub{font-size:13px;color:var(--muted)}.detail-btns{display:flex;gap:8px}
    .stats-panel{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:16px;margin-bottom:16px}.stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}@media(min-width:400px){.stats-grid{grid-template-columns:repeat(3,1fr)}}
    .stat-card{background:var(--bg);border-radius:8px;padding:12px}.stat-card-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px}.stat-card-lbl{font-size:11px;color:var(--muted);text-transform:uppercase}.stat-card-badge{font-size:9px;padding:2px 6px;border-radius:4px;font-weight:600}.stat-card-badge.good{background:rgba(16,185,129,.15);color:var(--success)}.stat-card-badge.warn{background:rgba(245,158,11,.15);color:var(--warn)}.stat-card-badge.bad{background:rgba(239,68,68,.15);color:var(--danger)}.stat-card-val{font-family:'JetBrains Mono',monospace;font-size:22px;font-weight:600}.stat-card-target{font-size:10px;color:var(--muted)}
    .ing-section{background:var(--card);border:1px solid var(--border);border-radius:var(--r);overflow:hidden}.ing-header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border)}.ing-title{font-size:14px;font-weight:600}
    .ing-row{display:flex;align-items:center;padding:12px 16px;border-bottom:1px solid var(--border)}.ing-row:last-child{border-bottom:none}.ing-name{flex:1;font-size:14px}.ing-amt{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:500;color:var(--accent);min-width:80px;text-align:right}.ing-remove{width:32px;height:32px;border-radius:6px;border:none;background:transparent;color:var(--muted);font-size:18px;cursor:pointer;margin-left:8px}.ing-remove:hover{background:rgba(239,68,68,.15);color:var(--danger)}
    .total-row{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:var(--bg);font-weight:600}.total-val{font-family:'JetBrains Mono',monospace;color:var(--accent)}
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(4px);display:flex;align-items:flex-end;justify-content:center;z-index:1000}@media(min-width:500px){.modal-overlay{align-items:center;padding:20px}}
    .modal{background:var(--card);border-radius:var(--r) var(--r) 0 0;width:100%;max-width:480px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column}@media(min-width:500px){.modal{border-radius:var(--r)}}
    .modal-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border)}.modal-title{font-size:18px;font-weight:600}.modal-close{width:36px;height:36px;border-radius:8px;border:none;background:transparent;color:var(--muted);font-size:24px;cursor:pointer}
    .modal-body{flex:1;overflow-y:auto;padding:20px}.modal-footer{padding:16px 20px;border-top:1px solid var(--border);display:flex;gap:12px}
    .btn{flex:1;padding:14px 20px;border-radius:8px;border:none;font-size:14px;font-weight:600;cursor:pointer}.btn-primary{background:var(--accent);color:var(--bg)}.btn-secondary{background:var(--input);color:var(--text)}.btn:disabled{opacity:.5;cursor:not-allowed}
    .form-group{margin-bottom:16px}.form-label{display:block;font-size:12px;font-weight:500;color:var(--text2);margin-bottom:6px}.form-input{width:100%;padding:12px 14px;border-radius:8px;border:1px solid var(--border);background:var(--input);color:var(--text);font-size:15px}.form-input:focus{outline:none;border-color:var(--accent)}.form-select{width:100%;padding:12px 14px;border-radius:8px;border:1px solid var(--border);background:var(--input);color:var(--text);font-size:15px;cursor:pointer}
    .search-box{position:relative}.search-results{position:absolute;top:100%;left:0;right:0;background:var(--card);border:1px solid var(--border);border-radius:8px;margin-top:4px;max-height:220px;overflow-y:auto;z-index:10}.search-item{padding:12px 14px;cursor:pointer;border-bottom:1px solid var(--border)}.search-item:last-child{border-bottom:none}.search-item:hover{background:var(--input)}.search-item-name{font-size:14px;font-weight:500}.search-item-meta{font-size:11px;color:var(--muted);margin-top:2px}
    .settings-card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);margin-bottom:16px;overflow:hidden}.settings-card-title{padding:14px 16px;font-size:13px;font-weight:600;border-bottom:1px solid var(--border)}.settings-row{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border);cursor:pointer}.settings-row:last-child{border-bottom:none}.settings-row:hover{background:var(--bg)}.settings-text{font-size:14px}.settings-value{font-size:14px;color:var(--muted)}.settings-danger .settings-card-title{color:var(--danger)}.settings-danger .settings-row{color:var(--danger)}
    .empty{text-align:center;padding:60px 20px}.empty-icon{font-size:56px;margin-bottom:16px;opacity:.4}.empty-title{font-size:18px;font-weight:600;margin-bottom:8px}.empty-text{color:var(--muted);margin-bottom:24px}
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const{useState,useEffect,useMemo}=React;
const V='4.0.0',D='2025-12-08';
const INGS=[
{id:1,name:'Whole Milk 3.6%',fat:3.6,sugar:4.8,msnf:8.9,solids:12.5,pac:4.8,pod:16,cat:'dairy'},
{id:2,name:'Cream 38%',fat:38,sugar:2.6,msnf:5.2,solids:45.8,pac:2.6,pod:9,cat:'dairy'},
{id:3,name:'Cream 40%',fat:40,sugar:2.5,msnf:5,solids:47.5,pac:2.5,pod:8,cat:'dairy'},
{id:4,name:'Skim Milk Powder',fat:.8,sugar:52,msnf:97,solids:97,pac:52,pod:52,cat:'dairy'},
{id:5,name:'Buttermilk',fat:.9,sugar:4.8,msnf:8.5,solids:9.4,pac:4.8,pod:16,cat:'dairy'},
{id:10,name:'Sucrose',fat:0,sugar:100,msnf:0,solids:100,pac:100,pod:100,cat:'sugar'},
{id:11,name:'Dextrose',fat:0,sugar:92,msnf:0,solids:92,pac:180,pod:70,cat:'sugar'},
{id:12,name:'Glucose Syrup 38DE',fat:0,sugar:80,msnf:0,solids:80,pac:90,pod:45,cat:'sugar'},
{id:13,name:'Glucose Powder 42DE',fat:0,sugar:95,msnf:0,solids:95,pac:90,pod:45,cat:'sugar'},
{id:14,name:'Inulin',fat:0,sugar:0,msnf:0,solids:92,pac:10,pod:10,cat:'sugar'},
{id:15,name:'Trimoline',fat:0,sugar:78,msnf:0,solids:78,pac:190,pod:130,cat:'sugar'},
{id:16,name:'Maltodextrin',fat:0,sugar:5,msnf:0,solids:95,pac:10,pod:10,cat:'sugar'},
{id:20,name:'Tara Gum',fat:0,sugar:0,msnf:0,solids:90,pac:0,pod:0,cat:'stab'},
{id:21,name:'Guar Gum',fat:0,sugar:0,msnf:0,solids:90,pac:0,pod:0,cat:'stab'},
{id:22,name:'Kappa Carrageenan',fat:0,sugar:0,msnf:0,solids:90,pac:0,pod:0,cat:'stab'},
{id:23,name:'Locust Bean Gum',fat:0,sugar:0,msnf:0,solids:90,pac:0,pod:0,cat:'stab'},
{id:30,name:'Cacao 22-24%',fat:23,sugar:0,msnf:0,solids:97,pac:0,pod:0,cat:'choc'},
{id:31,name:'Callebaut 70.5%',fat:41,sugar:28,msnf:0,solids:99,pac:28,pod:28,cat:'choc'},
{id:32,name:'Chocolate 66%',fat:40,sugar:30,msnf:0,solids:99,pac:30,pod:30,cat:'choc'},
{id:40,name:'Hazelnut Paste',fat:61,sugar:6,msnf:0,solids:98,pac:6,pod:6,cat:'nuts'},
{id:41,name:'Pistachio Paste',fat:54,sugar:8,msnf:0,solids:98,pac:8,pod:8,cat:'nuts'},
{id:50,name:'Boiron Coconut',fat:24,sugar:3,msnf:0,solids:31,pac:5,pod:5,cat:'fruit'},
{id:51,name:'Boiron Blueberry',fat:.3,sugar:10,msnf:0,solids:13,pac:19,pod:19,cat:'fruit'},
{id:52,name:'Strawberry Pur√©e',fat:.3,sugar:5,msnf:0,solids:8,pac:10,pod:10,cat:'fruit'},
{id:53,name:'Passion Fruit Pur√©e',fat:.7,sugar:11,msnf:0,solids:23,pac:21,pod:21,cat:'fruit'},
{id:54,name:'Rhubarb Strawberry Pur√©e',fat:.2,sugar:4,msnf:0,solids:7,pac:8,pod:8,cat:'fruit'},
{id:55,name:'Lemon Juice',fat:0,sugar:2.5,msnf:0,solids:3,pac:5,pod:5,cat:'fruit'},
{id:60,name:'Coconut Oil',fat:100,sugar:0,msnf:0,solids:100,pac:0,pod:0,cat:'fat'},
{id:61,name:'Olive Oil',fat:100,sugar:0,msnf:0,solids:100,pac:0,pod:0,cat:'fat'},
{id:70,name:'Water',fat:0,sugar:0,msnf:0,solids:0,pac:0,pod:0,cat:'other'},
{id:71,name:'Sea Salt',fat:0,sugar:0,msnf:0,solids:100,pac:0,pod:0,cat:'other'},
];
const DEF_RECIPES=[
{id:1,name:'Chocolate Sorbet',type:'sorbet',items:[{ingId:70,amt:2600},{ingId:10,amt:800},{ingId:11,amt:240},{ingId:16,amt:100},{ingId:20,amt:13.5},{ingId:30,amt:240}]},
{id:2,name:'Buttermilk Gelato',type:'gelato',items:[{ingId:1,amt:1431},{ingId:2,amt:858},{ingId:5,amt:716},{ingId:10,amt:626},{ingId:11,amt:179},{ingId:12,amt:90},{ingId:4,amt:90},{ingId:20,amt:13.5}]},
{id:3,name:'Chocolate Gelato w/ Callebaut',type:'gelato',items:[{ingId:1,amt:2405},{ingId:12,amt:185},{ingId:11,amt:148},{ingId:4,amt:111},{ingId:30,amt:67},{ingId:10,amt:259},{ingId:20,amt:13.5},{ingId:31,amt:740},{ingId:15,amt:74}]},
{id:4,name:'Blueberry-Coconut Sorbet',type:'sorbet',items:[{ingId:50,amt:998},{ingId:51,amt:1996},{ingId:10,amt:499},{ingId:12,amt:200},{ingId:11,amt:200},{ingId:70,amt:100},{ingId:20,amt:13.5}]},
{id:5,name:'Strawberry Gelato',type:'gelato',items:[{ingId:52,amt:1186},{ingId:1,amt:822},{ingId:3,amt:889},{ingId:10,amt:267},{ingId:11,amt:283},{ingId:12,amt:118},{ingId:4,amt:89},{ingId:20,amt:13.5},{ingId:70,amt:334}]},
{id:6,name:'Passion Fruit Sorbet',type:'sorbet',items:[{ingId:53,amt:1200},{ingId:55,amt:40},{ingId:10,amt:720},{ingId:11,amt:120},{ingId:12,amt:160},{ingId:20,amt:20},{ingId:70,amt:1420},{ingId:14,amt:320}]},
{id:7,name:'Coconut-Vanilla Gelato',type:'gelato',items:[{ingId:3,amt:68},{ingId:1,amt:1689},{ingId:50,amt:1351},{ingId:10,amt:676},{ingId:11,amt:68},{ingId:12,amt:68},{ingId:20,amt:13.5},{ingId:60,amt:68}]},
{id:8,name:'Salted Caramel Gelato',type:'gelato',items:[{ingId:10,amt:579},{ingId:71,amt:16},{ingId:20,amt:13.5},{ingId:1,amt:2597},{ingId:3,amt:480},{ingId:4,amt:180},{ingId:13,amt:105},{ingId:14,amt:80}]},
{id:9,name:'Fior di Latte',type:'gelato',items:[{ingId:1,amt:2232},{ingId:2,amt:750},{ingId:4,amt:150},{ingId:10,amt:400},{ingId:11,amt:120},{ingId:12,amt:336},{ingId:20,amt:8},{ingId:21,amt:5},{ingId:22,amt:2}]},
{id:10,name:'Fior di Latte TEST (Glucose Syrup)',type:'gelato',items:[{ingId:1,amt:1115},{ingId:2,amt:375},{ingId:4,amt:75},{ingId:10,amt:200},{ingId:11,amt:60},{ingId:12,amt:168},{ingId:20,amt:4},{ingId:21,amt:2.5},{ingId:22,amt:1}]},
{id:11,name:'Lemon Olive Oil Gelato',type:'gelato',items:[{ingId:1,amt:1400},{ingId:2,amt:800},{ingId:4,amt:90},{ingId:10,amt:200},{ingId:11,amt:150},{ingId:12,amt:280},{ingId:20,amt:13.5},{ingId:61,amt:80},{ingId:55,amt:100}]},
{id:12,name:'Rhubarb Strawberry Gelato',type:'gelato',items:[{ingId:54,amt:2308},{ingId:1,amt:1730},{ingId:2,amt:1730},{ingId:10,amt:520},{ingId:11,amt:720},{ingId:12,amt:230},{ingId:4,amt:174},{ingId:20,amt:13.5},{ingId:70,amt:576}]},
];
const TGTS={gelato:{fat:{min:6,max:10,ideal:9},sugar:{min:18,max:26,ideal:25},msnf:{min:6,max:12,ideal:9},solids:{min:35,max:42,ideal:38}},sorbet:{fat:{min:0,max:3,ideal:0},sugar:{min:24,max:32,ideal:28},msnf:{min:0,max:2,ideal:0},solids:{min:28,max:38,ideal:32}}};
const getIng=id=>INGS.find(i=>i.id===id);
const calc=items=>{let tw=0,tf=0,ts=0,tm=0,tso=0,tpac=0,tpod=0;items.forEach(it=>{const ing=getIng(it.ingId);if(!ing)return;tw+=it.amt;tf+=(it.amt*ing.fat)/100;ts+=(it.amt*ing.sugar)/100;tm+=(it.amt*ing.msnf)/100;tso+=(it.amt*ing.solids)/100;tpac+=(it.amt*ing.pac)/100;tpod+=(it.amt*ing.pod)/100});if(tw===0)return{tw:0,fat:0,sugar:0,msnf:0,solids:0,fp:0,pod:0};return{tw,fat:(tf/tw)*100,sugar:(ts/tw)*100,msnf:(tm/tw)*100,solids:(tso/tw)*100,fp:-(tpac/tw)*.1,pod:tpod/tw}};
const getSt=(v,t)=>{if(!t)return'good';if(v>=t.min&&v<=t.max)return'good';if(Math.abs(v-t.ideal)<=(t.max-t.min)*.6)return'warn';return'bad'};
function PinScreen({onUnlock}){const[pin,setPin]=useState('');const[err,setErr]=useState(false);const handleKey=k=>{if(err)setErr(false);if(k==='back')return setPin(p=>p.slice(0,-1));if(pin.length<4){const np=pin+k;setPin(np);if(np.length===4){if(np==='0119')setTimeout(onUnlock,150);else{setErr(true);setTimeout(()=>{setPin('');setErr(false)},400)}}}};return(<div className="pin-screen"><div className="pin-logo">üç®</div><h1 className="pin-title">Gelato Formulator</h1><p className="pin-sub">Enter PIN to continue</p><div className="pin-dots">{[0,1,2,3].map(i=><div key={i} className={`pin-dot ${pin.length>i?'filled':''} ${err?'error':''}`}/>)}</div><div className="pin-pad">{[1,2,3,4,5,6,7,8,9,'',0,'‚Üê'].map((k,i)=><button key={i} className={`pin-key ${k===''?'empty':''}`} onClick={()=>k!==''&&handleKey(k==='‚Üê'?'back':String(k))}>{k}</button>)}</div></div>)}
function App(){const[unlocked,setUnlocked]=useState(false);const[tab,setTab]=useState('recipes');const[recipes,setRecipes]=useState([]);const[filter,setFilter]=useState('all');const[selRecipe,setSelRecipe]=useState(null);const[editMode,setEditMode]=useState(false);const[showNew,setShowNew]=useState(false);const[showAddIng,setShowAddIng]=useState(false);
useEffect(()=>{const saved=localStorage.getItem('gelato-v4');if(saved)setRecipes(JSON.parse(saved));else{setRecipes(DEF_RECIPES);localStorage.setItem('gelato-v4',JSON.stringify(DEF_RECIPES))}if(sessionStorage.getItem('gelato-unlocked'))setUnlocked(true)},[]);
useEffect(()=>{if(recipes.length)localStorage.setItem('gelato-v4',JSON.stringify(recipes))},[recipes]);
const handleUnlock=()=>{setUnlocked(true);sessionStorage.setItem('gelato-unlocked','1')};
const filtered=useMemo(()=>filter==='all'?recipes:recipes.filter(r=>r.type===filter),[recipes,filter]);
const handleSave=r=>{setRecipes(prev=>{const idx=prev.findIndex(x=>x.id===r.id);if(idx>=0){const u=[...prev];u[idx]=r;return u}return[...prev,{...r,id:Date.now()}]});setSelRecipe(r);setEditMode(false);setShowNew(false)};
const handleDelete=id=>{if(confirm('Delete this recipe?')){setRecipes(p=>p.filter(r=>r.id!==id));setSelRecipe(null)}};
const handleDupe=r=>{const nr={...r,id:Date.now(),name:`${r.name} (Copy)`,items:[...r.items]};setRecipes(p=>[...p,nr]);setSelRecipe(nr)};
const handleExport=()=>{const blob=new Blob([JSON.stringify(recipes,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`gelato-${new Date().toISOString().split('T')[0]}.json`;a.click()};
const handleImport=()=>{const inp=document.createElement('input');inp.type='file';inp.accept='.json';inp.onchange=e=>{const reader=new FileReader();reader.onload=ev=>{try{const d=JSON.parse(ev.target.result);if(Array.isArray(d)){setRecipes(d);alert(`Imported ${d.length} recipes`)}}catch{alert('Invalid file')}};reader.readAsText(e.target.files[0])};inp.click()};
const handleReset=()=>{if(confirm('Reset all recipes to defaults?')){setRecipes(DEF_RECIPES);localStorage.setItem('gelato-v4',JSON.stringify(DEF_RECIPES));setSelRecipe(null)}};
if(!unlocked)return<PinScreen onUnlock={handleUnlock}/>;
return(<div className="app"><header className="header"><div className="header-top"><div className="header-brand"><span className="header-icon">üç®</span><span className="header-title">Gelato Formulator</span></div><div className="header-btns"><button className="icon-btn" onClick={handleExport}>üì§</button><button className="icon-btn" onClick={handleImport}>üì•</button></div></div><div className="tabs"><button className={`tab ${tab==='recipes'?'active':''}`} onClick={()=>{setTab('recipes');setSelRecipe(null)}}>Recipes</button><button className={`tab ${tab==='ingredients'?'active':''}`} onClick={()=>setTab('ingredients')}>Ingredients</button><button className={`tab ${tab==='settings'?'active':''}`} onClick={()=>setTab('settings')}>Settings</button></div></header>
<main className="content">{tab==='recipes'&&!selRecipe&&<><div className="page-header"><div><h2 className="page-title">Recipes</h2><span className="page-sub">{filtered.length} recipes</span></div><button className="add-btn" onClick={()=>setShowNew(true)}>+ New Recipe</button></div><div className="filters">{['all','gelato','sorbet'].map(f=><button key={f} className={`filter ${filter===f?'active':''}`} onClick={()=>setFilter(f)}>{f.charAt(0).toUpperCase()+f.slice(1)}</button>)}</div>{filtered.length===0?<div className="empty"><div className="empty-icon">üìù</div><h3 className="empty-title">No recipes yet</h3><p className="empty-text">Create your first recipe</p><button className="add-btn" onClick={()=>setShowNew(true)}>+ New Recipe</button></div>:<div className="recipe-grid">{filtered.map(r=><RecipeCard key={r.id} recipe={r} onClick={()=>setSelRecipe({...r})}/>)}</div>}</>}
{tab==='recipes'&&selRecipe&&<RecipeDetail recipe={selRecipe} editMode={editMode} setEditMode={setEditMode} onBack={()=>setSelRecipe(null)} onSave={handleSave} onDelete={()=>handleDelete(selRecipe.id)} onDupe={()=>handleDupe(selRecipe)} onChange={setSelRecipe} showAddIng={showAddIng} setShowAddIng={setShowAddIng}/>}
{tab==='ingredients'&&<IngredientList/>}{tab==='settings'&&<Settings count={recipes.length} onReset={handleReset}/>}</main>
{showNew&&<NewRecipeModal onClose={()=>setShowNew(false)} onSave={handleSave}/>}</div>)}
function RecipeCard({recipe,onClick}){const c=calc(recipe.items);const t=TGTS[recipe.type];return(<div className="recipe-card" onClick={onClick}><div className="recipe-top"><div className="recipe-info"><span className="recipe-emoji">{recipe.type==='gelato'?'üç®':'üçß'}</span><div><div className="recipe-name">{recipe.name}</div><div className="recipe-meta">{recipe.items.length} ing ‚Ä¢ {c.tw.toFixed(0)}g</div></div></div><span className={`badge badge-${recipe.type}`}>{recipe.type}</span></div><div className="stats"><div className="stat-box"><div className={`stat-val ${getSt(c.fat,t.fat)}`}>{c.fat.toFixed(1)}%</div><div className="stat-lbl">Fat</div></div><div className="stat-box"><div className={`stat-val ${getSt(c.sugar,t.sugar)}`}>{c.sugar.toFixed(1)}%</div><div className="stat-lbl">Sugar</div></div><div className="stat-box"><div className={`stat-val ${getSt(c.solids,t.solids)}`}>{c.solids.toFixed(1)}%</div><div className="stat-lbl">Solids</div></div><div className="stat-box"><div className="stat-val">{c.fp.toFixed(1)}¬∞</div><div className="stat-lbl">FP</div></div></div></div>)}
function RecipeDetail({recipe,editMode,setEditMode,onBack,onSave,onDelete,onDupe,onChange,showAddIng,setShowAddIng}){const c=calc(recipe.items);const t=TGTS[recipe.type];const updateAmt=(idx,amt)=>{const ni=[...recipe.items];ni[idx]={...ni[idx],amt:parseFloat(amt)||0};onChange({...recipe,items:ni})};const removeIng=idx=>onChange({...recipe,items:recipe.items.filter((_,i)=>i!==idx)});const addIng=(ingId,amt)=>{onChange({...recipe,items:[...recipe.items,{ingId,amt}]});setShowAddIng(false)};
return(<div><div className="detail-header"><button className="back-btn" onClick={onBack}>‚Üê</button><div className="detail-title"><h2 className="detail-name">{recipe.name}</h2><div className="detail-sub">{recipe.type} ‚Ä¢ {c.tw.toFixed(0)}g</div></div><div className="detail-btns">{editMode?<button className="icon-btn" onClick={()=>onSave(recipe)} style={{background:'var(--success)',color:'white'}}>‚úì</button>:<><button className="icon-btn" onClick={()=>setEditMode(true)}>‚úèÔ∏è</button><button className="icon-btn" onClick={onDupe}>üìã</button><button className="icon-btn" onClick={onDelete} style={{color:'var(--danger)'}}>üóëÔ∏è</button></>}</div></div>
<div className="stats-panel"><div className="stats-grid"><StatCard label="Fat" value={c.fat} target={t.fat} unit="%"/><StatCard label="Sugar" value={c.sugar} target={t.sugar} unit="%"/><StatCard label="MSNF" value={c.msnf} target={t.msnf} unit="%"/><StatCard label="Solids" value={c.solids} target={t.solids} unit="%"/><StatCard label="F.Point" value={c.fp} unit="¬∞C"/><StatCard label="POD" value={c.pod} unit=""/></div></div>
<div className="ing-section"><div className="ing-header"><span className="ing-title">Ingredients</span>{editMode&&<button className="add-btn" onClick={()=>setShowAddIng(true)} style={{padding:'8px 12px',fontSize:'12px'}}>+ Add</button>}</div>{recipe.items.map((it,idx)=>{const ing=getIng(it.ingId);if(!ing)return null;return(<div key={idx} className="ing-row"><span className="ing-name">{ing.name}</span>{editMode?<input type="number" value={it.amt} onChange={e=>updateAmt(idx,e.target.value)} className="form-input" style={{width:'90px',textAlign:'right',padding:'8px'}}/>:<span className="ing-amt">{it.amt}g</span>}{editMode&&<button className="ing-remove" onClick={()=>removeIng(idx)}>√ó</button>}</div>)})}<div className="total-row"><span>Total</span><span className="total-val">{c.tw.toFixed(0)}g</span></div></div>
{showAddIng&&<AddIngModal onClose={()=>setShowAddIng(false)} onAdd={addIng} existingIds={recipe.items.map(i=>i.ingId)}/>}</div>)}
function StatCard({label,value,target,unit}){const st=getSt(value,target);return(<div className="stat-card"><div className="stat-card-top"><span className="stat-card-lbl">{label}</span>{target&&<span className={`stat-card-badge ${st}`}>{st==='good'?'‚úì':st==='warn'?'~':'!'}</span>}</div><div className={`stat-card-val ${st}`}>{value.toFixed(1)}{unit}</div>{target&&<div className="stat-card-target">{target.min}‚Äì{target.max}{unit}</div>}</div>)}
function NewRecipeModal({onClose,onSave}){const[name,setName]=useState('');const[type,setType]=useState('gelato');const handleSubmit=()=>{if(name.trim())onSave({id:Date.now(),name:name.trim(),type,items:[]})};return(<div className="modal-overlay" onClick={onClose}><div className="modal" onClick={e=>e.stopPropagation()}><div className="modal-header"><h3 className="modal-title">New Recipe</h3><button className="modal-close" onClick={onClose}>√ó</button></div><div className="modal-body"><div className="form-group"><label className="form-label">Recipe Name</label><input type="text" className="form-input" placeholder="e.g. Pistachio Gelato" value={name} onChange={e=>setName(e.target.value)} autoFocus/></div><div className="form-group"><label className="form-label">Type</label><select className="form-select" value={type} onChange={e=>setType(e.target.value)}><option value="gelato">Gelato</option><option value="sorbet">Sorbet</option></select></div></div><div className="modal-footer"><button className="btn btn-secondary" onClick={onClose}>Cancel</button><button className="btn btn-primary" onClick={handleSubmit} disabled={!name.trim()}>Create</button></div></div></div>)}
function AddIngModal({onClose,onAdd,existingIds}){const[search,setSearch]=useState('');const[selId,setSelId]=useState(null);const[amt,setAmt]=useState('');const filtered=INGS.filter(i=>!existingIds.includes(i.id)&&i.name.toLowerCase().includes(search.toLowerCase()));const handleAdd=()=>{if(selId&&amt)onAdd(selId,parseFloat(amt))};return(<div className="modal-overlay" onClick={onClose}><div className="modal" onClick={e=>e.stopPropagation()}><div className="modal-header"><h3 className="modal-title">Add Ingredient</h3><button className="modal-close" onClick={onClose}>√ó</button></div><div className="modal-body"><div className="form-group search-box"><label className="form-label">Search Ingredient</label><input type="text" className="form-input" placeholder="Type to search..." value={search} onChange={e=>{setSearch(e.target.value);setSelId(null)}} autoFocus/>{search&&!selId&&<div className="search-results">{filtered.slice(0,8).map(i=><div key={i.id} className="search-item" onClick={()=>{setSelId(i.id);setSearch(i.name)}}><div className="search-item-name">{i.name}</div><div className="search-item-meta">Fat: {i.fat}% ‚Ä¢ Sugar: {i.sugar}% ‚Ä¢ Solids: {i.solids}%</div></div>)}{filtered.length===0&&<div className="search-item"><div className="search-item-name" style={{color:'var(--muted)'}}>No results</div></div>}</div>}</div>{selId&&<div className="form-group"><label className="form-label">Amount (grams)</label><input type="number" className="form-input" placeholder="e.g. 500" value={amt} onChange={e=>setAmt(e.target.value)}/></div>}</div><div className="modal-footer"><button className="btn btn-secondary" onClick={onClose}>Cancel</button><button className="btn btn-primary" onClick={handleAdd} disabled={!selId||!amt}>Add</button></div></div></div>)}
function IngredientList(){const[search,setSearch]=useState('');const[cat,setCat]=useState('all');const cats=['all','dairy','sugar','stab','choc','fruit','nuts','fat','other'];const filtered=INGS.filter(i=>(cat==='all'||i.cat===cat)&&i.name.toLowerCase().includes(search.toLowerCase()));return(<><div className="page-header"><div><h2 className="page-title">Ingredients</h2><span className="page-sub">{INGS.length} items</span></div></div><div className="form-group"><input type="text" className="form-input" placeholder="Search..." value={search} onChange={e=>setSearch(e.target.value)}/></div><div className="filters" style={{marginBottom:'16px'}}>{cats.map(c=><button key={c} className={`filter ${cat===c?'active':''}`} onClick={()=>setCat(c)}>{c==='stab'?'Stabilizer':c.charAt(0).toUpperCase()+c.slice(1)}</button>)}</div><div className="ing-section">{filtered.map(i=><div key={i.id} className="ing-row" style={{flexWrap:'wrap',gap:'6px'}}><span className="ing-name" style={{flex:'1 1 100%',marginBottom:'2px'}}>{i.name}</span><span style={{fontSize:'11px',color:'var(--muted)'}}>Fat: {i.fat}%</span><span style={{fontSize:'11px',color:'var(--muted)'}}>Sugar: {i.sugar}%</span><span style={{fontSize:'11px',color:'var(--muted)'}}>MSNF: {i.msnf}%</span><span style={{fontSize:'11px',color:'var(--muted)'}}>Solids: {i.solids}%</span></div>)}</div></>)}
function Settings({count,onReset}){return(<><h2 className="page-title" style={{marginBottom:'16px'}}>Settings</h2><div className="settings-card"><div className="settings-card-title">App Info</div><div className="settings-row"><span className="settings-text">Version</span><span className="settings-value">{V}</span></div><div className="settings-row"><span className="settings-text">Build</span><span className="settings-value">{D}</span></div><div className="settings-row"><span className="settings-text">Recipes</span><span className="settings-value">{count}</span></div><div className="settings-row"><span className="settings-text">Ingredients</span><span className="settings-value">{INGS.length}</span></div></div><div className="settings-card"><div className="settings-card-title">Gelato Targets (Luca)</div><div className="settings-row"><span className="settings-text">Sugar</span><span className="settings-value">25%</span></div><div className="settings-row"><span className="settings-text">Fat</span><span className="settings-value">9%</span></div><div className="settings-row"><span className="settings-text">Total Solids</span><span className="settings-value">38%</span></div><div className="settings-row"><span className="settings-text">Freezing Point</span><span className="settings-value">-2.9¬∞C</span></div><div className="settings-row"><span className="settings-text">SMP Range</span><span className="settings-value">2.5‚Äì5%</span></div></div><div className="settings-card settings-danger"><div className="settings-card-title">Danger Zone</div><div className="settings-row" onClick={onReset}><span className="settings-text">Reset All Data</span><span className="settings-value">‚Üí</span></div></div></>)}
ReactDOM.render(<App/>,document.getElementById('root'));
</script>
</body>
</html>
